<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Course Questionnaire</title>
  <link rel="stylesheet" href="./assets/style.css"/>
  <link rel="stylesheet" href="./styles/questionnaire-only.css">
</head>
<body data-page="questionnaire">
<header class="site-header">
  <div class="container">
    <div class="brand"><div class="uf-block">UF</div><h1>Course Questionnaire</h1></div>
    <nav class="site-nav"><a href="./index.html" class="nav-link">Home</a></nav>
  </div>
</header>

<main class="container">
  <div id="question-list" class="question-list"></div>
  <div class="actions">
    <button id="save" class="btn btn-orange">Save</button>
    <div id="alert" class="alert" hidden></div>
  </div>
</main>

<script type="module">
import { qs, el, saveViaVercel } from './assets/ui.js';

// -------------------- CONFIG --------------------
// Use HTTPS for remote (ngrok) backends to avoid mixed-content blocking
const BACKEND_URL = 'https://saunciest-unethereal-clora.ngrok-free.dev';
// const BACKEND_URL = 'http://localhost:8787'; // toggle for local dev

// -------------------- PARAMS --------------------
const params = new URLSearchParams(location.search);
const courseId = params.get('id') || 'default';
const alertBox = qs('#alert');

let questions = [];

// -------------------- LOAD QUESTIONS --------------------
async function loadQuestions() {
  try {
    // keep local JSON loading as-is
    const res = await fetch(`./data/questions/${encodeURIComponent(courseId)}.json`, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Failed to load questions (${res.status})`);
    questions = await res.json();

    const container = qs('#question-list');
    container.innerHTML = '';

    questions.forEach((q, i) => {
      const fieldId = `q_${i}`;
      const block = el('div', { class: 'question-card' });
      const label = el('div', { class: 'question-text' }, q.prompt || q.Question);
      block.append(label);

      if (q.type === 'radio' || q.Type === 'MCQ') {
        const opts = q.options || q['Answer Options'] || [];
        const optWrap = el('div', { id: fieldId, class: 'options-group' });
        opts.forEach(opt => {
          const lab = el('label', { class: 'answer-option' });
          const input = el('input', { type: 'radio', name: fieldId, value: opt });
          lab.append(input, ' ', opt);
          optWrap.append(lab);
        });
        block.append(optWrap);
      } else {
        const input = el('textarea', {
          id: fieldId,
          rows: 3,
          class: 'input-text',
          placeholder: 'Type your answer here...'
        });
        block.append(input);
      }

      container.append(block);
    });
  } catch (e) {
    console.error(e);
    alertBox.hidden = false;
    alertBox.textContent = ('Failed to load questions: ' + e.message).slice(0, 300);
  }
}

function valueOf(input) {
  if (!input) return '';
  if (input.tagName === 'TEXTAREA') return input.value.trim();
  const checked = input.querySelector('input:checked');
  if (checked) return checked.value;
  return '';
}

// -------------------- SAVE --------------------
qs('#save').addEventListener('click', async () => {
  const btn = qs('#save');
  btn.disabled = true;
  btn.textContent = 'Saving…';
  alertBox.hidden = true;

  const responses = questions.map((q, i) => {
    const fieldId = `q_${i}`;
    const input = document.getElementById(fieldId) || document.querySelector(`[name="${fieldId}"]`);
    return {
      question: q.prompt || q.Question || '',
      answer: valueOf(input)
    };
  });

  const payload = {
    course: courseId,
    savedAt: new Date().toISOString(),
    responses
  };

  try {
    const url = `${BACKEND_URL}/api/saveAnswers?ngrok-skip-browser-warning=true&_=${Date.now()}`;
    const res = await fetch(url, {
      method: 'POST',
      cache: 'no-store',
      headers: {
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const errText = await res.text().catch(() => '');
      throw new Error(`Failed to save answers (${res.status}): ${errText}`);
    }

    const result = await res.json().catch(() => ({}));
    console.log('✅ Saved to backend:', result);

    // Preserve ALL original query params when redirecting
    const next = new URL('./loading.html', location.href);
    next.search = location.search || `?id=${encodeURIComponent(courseId)}`;
    window.location.href = next.toString();

  } catch (e) {
    console.error('❌ Error saving to backend:', e);
    alertBox.hidden = false;
    alertBox.textContent = ('' + e.message).slice(0, 300);
    btn.disabled = false;
    btn.textContent = 'Save';
  }
});

loadQuestions();
</script>
</body>
</html>
