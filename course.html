<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Course Questions</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>
<body>
<header class="site-header">
  <div class="container">
    <div class="brand"><div class="uf-block">UF</div><h1>Course Questionnaire</h1></div>
    <nav class="site-nav"><a href="./index.html" class="nav-link">Home</a></nav>
  </div>
</header>

<main class="container">
  <div id="question-list" class="question-list"></div>
  <div class="actions">
    <button id="save" class="btn btn-orange">Save</button>
    <div id="alert" class="alert" hidden></div>
  </div>
</main>

<script type="module">
import { qs, el, saveViaVercel } from './assets/ui.js';

const params = new URLSearchParams(location.search);
const courseId = params.get('id');
const alertBox = qs('#alert');

let questions = [];

// ---------- Load and render questions ----------
async function loadQuestions() {
  const res = await fetch(`./data/questions/${courseId}.json`, { cache: 'no-store' });
  questions = await res.json();
  const container = qs('#question-list');
  container.innerHTML = '';

  questions.forEach((q, i) => {
    const fieldId = `q_${i}`;
    const block = el('div', { class: 'question-block' });
    const label = el('div', { class: 'question-text' }, q.prompt || q.Question);
    block.append(label);

    if (q.type === 'radio' || q.Type === 'MCQ') {
      const opts = q.options || q['Answer Options'] || [];
      const optWrap = el('div', { id: fieldId, class: 'radios' });
      opts.forEach(opt => {
        const lab = el('label', { class: 'answer-option' });
        const input = el('input', { type: 'radio', name: fieldId, value: opt });
        lab.append(input, ' ', opt);
        optWrap.append(lab);
      });
      block.append(optWrap);
    } else {
      const input = el('textarea', { id: fieldId, rows: 2, class: 'input', placeholder: 'Your answer' });
      block.append(input);
    }

    container.append(block);
  });
}

// ---------- Helper to read value ----------
function valueOf(input) {
  if (!input) return '';
  if (input.tagName === 'TEXTAREA') return input.value.trim();
  const checked = input.querySelector('input:checked');
  if (checked) return checked.value;
  return '';
}

// ---------- Save ----------
qs('#save').addEventListener('click', async () => {
  const btn = qs('#save');
  btn.disabled = true;
  btn.textContent = 'Savingâ€¦';
  alertBox.hidden = true;

  // Build responses with question + answer
  const responses = questions.map((q, i) => {
    const fieldId = `q_${i}`;
    const input = document.getElementById(fieldId) || document.querySelector(`[name="${fieldId}"]`);
    return {
      key: q.key || `q_${i}`,
      question: q.prompt || q.Question || '',
      type: q.type || q.Type || 'text',
      answer: valueOf(input)
    };
  });

  // Optional compact shape
  const answers = {};
  responses.forEach(r => { answers[r.key] = r.answer; });

  const payload = {
    course: courseId,
    savedAt: new Date().toISOString(),
    responses,
    answers
  };

  try {
    await saveViaVercel(payload);
    window.location.href = `./course-video.html?id=${encodeURIComponent(courseId)}`;
  } catch (e) {
    console.error(e);
    alertBox.hidden = false;
    alertBox.textContent = ('' + e.message).slice(0, 300);
    btn.disabled = false;
    btn.textContent = 'Save';
  }
});

loadQuestions();
</script>
</body>
</html>
