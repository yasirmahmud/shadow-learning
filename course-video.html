<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Course Video</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>
<body>
<header class="site-header">
  <div class="container">
    <div class="brand"><div class="uf-block">UF</div><h1 id="course-title">Course Video</h1></div>
    <nav class="site-nav"><a href="./index.html" class="nav-link">Home</a></nav>
  </div>
</header>

<main class="container">
  <div id="meta" class="panel"><h2 id="title" class="panel-title"></h2><p id="desc" class="video-meta"></p></div>

  <div id="wrap" class="yt-wrap yt-16x9">
    <div id="player"></div>
    <div id="overlay" class="overlay" aria-hidden="true"></div>
  </div>

  <section id="chat" class="chat" hidden>
    <div class="chat-header">
      <strong>Discussion</strong>
      <button id="exit-chat" class="btn btn-ghost btn-sm" type="button">Exit Chat</button>
    </div>
    <div id="thread"></div>
    <form id="compose" class="compose">
      <input id="msg" class="input" type="text" placeholder="Type your question and press Enter" autocomplete="off"/>
      <button class="btn btn-orange" type="submit">Send</button>
    </form>
  </section>
</main>

<script type="module">
import { qs, el, saveViaVercel, askLaptop } from './assets/ui.js';

// --- load course + url ---
const params = new URLSearchParams(location.search);
const courseId = params.get('id');

const courses = await (await fetch('./data/courses.json', { cache: 'no-store' })).json();
const course = courses.find(c => c.id === courseId);
if (!course) {
  document.getElementById('wrap').innerHTML = '<div style="color:#fff;padding:24px">Course not found.</div>';
  throw new Error('Course not found');
}
document.getElementById('course-title').textContent = course.title;
document.getElementById('title').textContent = course.title;
document.getElementById('desc').textContent = course.description || '';

// --- parse YouTube URL to id + start ---
function parseYouTube(u) {
  try {
    const url = new URL(u);
    let id = '', start = 0;
    if (url.hostname.includes('youtu.be')) {
      id = url.pathname.replace(/^\//, '');
      const t = url.searchParams.get('t'); if (t) start = parseInt(t, 10) || 0;
    } else if (url.hostname.includes('youtube.com')) {
      id = url.searchParams.get('v') || '';
      const t = url.searchParams.get('t'); if (t) start = parseInt(t, 10) || 0;
    }
    return { id, start };
  } catch {
    return { id: '', start: 0 };
  }
}

const v = course.video || {};
if (!(v.type === 'youtube' && v.url)) {
  document.getElementById('wrap').innerHTML = '<div style="color:#fff;padding:24px">No YouTube URL set for this course.</div>';
  throw new Error('No YouTube URL set');
}
const { id: videoId, start } = parseYouTube(v.url);
if (!videoId) {
  document.getElementById('wrap').innerHTML = '<div style="color:#fff;padding:24px">Invalid YouTube URL.</div>';
  throw new Error('Invalid YouTube URL');
}

// --- YouTube IFrame API bootstrap ---
await new Promise((resolve) => {
  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  window.onYouTubeIframeAPIReady = () => resolve();
  document.head.appendChild(tag);
});

const overlay = document.getElementById('overlay');
const chat = document.getElementById('chat');
const thread = document.getElementById('thread');
const msgInput = document.getElementById('msg');
const compose = document.getElementById('compose');
const exitBtn = document.getElementById('exit-chat');

let player;
let lastTime = start || 0;
let chatStarted = false;

// Create the player
player = new window.YT.Player('player', {
  videoId: videoId,
  playerVars: {
    start: start || 0,
    rel: 0,
    modestbranding: 1,
    controls: 1,
    iv_load_policy: 3
  },
  events: {
    onReady: (e) => {
      if (start) try { e.target.seekTo(start, true); } catch {}
    },
    onStateChange: (e) => {
      if (e.data === window.YT.PlayerState.PAUSED) {
        try { lastTime = Math.floor(player.getCurrentTime() || 0); } catch {}
        overlay.classList.add('show');   // pitch black
        chat.hidden = false;
        if (!chatStarted) { addMsg('ai', 'Do you have any questions about what you just watched?'); chatStarted = true; }
        msgInput.focus();
      } else if (e.data === window.YT.PlayerState.PLAYING) {
        overlay.classList.remove('show');
      }
    }
  }
});

// Space to pause + open chat (when not typing)
document.addEventListener('keydown', (e) => {
  const tag = (e.target.tagName || '').toLowerCase();
  const typing = e.target.isContentEditable || ['input','textarea','select','button'].includes(tag);
  if ((e.key === ' ' || e.code === 'Space' || e.key === 'Spacebar') && !typing) {
    e.preventDefault();
    try { player.pauseVideo(); } catch {}
  }
});

// --- chat helpers ---
function addMsg(role, text) {
  const row = document.createElement('div');
  row.className = 'msg ' + role;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  thread.appendChild(row);
  thread.scrollTop = thread.scrollHeight;
}

function collectTranscript() {
  return [...document.querySelectorAll('.msg')].map(m => ({
    role: m.classList.contains('ai') ? 'assistant' : 'user',
    content: m.textContent.trim()
  }));
}

// Submit to backend + save to GitHub
compose.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const text = msgInput.value.trim();
  if (!text) return;
  addMsg('user', text);
  msgInput.value = '';

  try {
    await saveViaVercel({
      course: courseId,
      savedAt: new Date().toISOString(),
      video_chat: { atSeconds: lastTime, videoId, messages: collectTranscript() }
    });
  } catch (e) { console.error(e); }

  try {
    const response = await askLaptop({
      courseId,
      atSeconds: lastTime,
      messages: collectTranscript().map(m => ({
        role: m.role === 'assistant' ? 'assistant' : 'user',
        content: m.content
      }))
    });
    addMsg('ai', response.reply || 'No response.');
  } catch (err) {
    console.error(err);
    addMsg('ai', 'The assistant is unavailable right now. Please try again in a moment.');
  }
});

// Exit chat
exitBtn.addEventListener('click', () => {
  chat.hidden = true;
  overlay.classList.remove('show');
  try { player.playVideo(); } catch {}
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !chat.hidden) {
    chat.hidden = true;
    overlay.classList.remove('show');
    try { player.playVideo(); } catch {}
  }
});


// === Relevant Video Timed Swap Logic ===
(async function(){
  async function loadRelevant() {
    try {
      const res = await fetch('./relevant_video.json', { cache: 'no-store' });
      if (!res.ok) return null;
      return await res.json();
    } catch(e){ console.warn('relevant_video.json not found', e); return null; }
  }
  const relevant = await loadRelevant();
  if (!relevant) return;

  const intime = Number(relevant.intime || 0);
  const videoUrl = String(relevant.video_url || '');
  const startTime = Number(relevant.start_time || 0);
  const endTime = Number(relevant.end_time || 0);
  const segmentDuration = Math.max(0, endTime - startTime);

  const yt = window.YT;
  if (!yt || !window.player || typeof window.player.getCurrentTime !== 'function') {
    console.warn('YT player not ready for timed swap.');
    return;
  }

  const mainWrap = document.getElementById('wrap') || document.getElementById('player')?.parentElement;
  const parent = mainWrap?.parentElement || document.body;
  const secondaryWrap = document.createElement('div');
  secondaryWrap.id = 'secondary-wrap';
  secondaryWrap.style.display = 'none';
  secondaryWrap.className = mainWrap?.className || 'yt-wrap yt-16x9';
  const secondaryDiv = document.createElement('div');
  secondaryDiv.id = 'secondary-player';
  secondaryWrap.appendChild(secondaryDiv);
  parent.insertBefore(secondaryWrap, (mainWrap ? mainWrap.nextSibling : null));

  let primaryElapsed = 0;
  let primaryTimerId = null;
  let paused = false;
  let segmentRunning = false;
  let secondaryPlayer = null;
  let segmentStartTs = 0;

  function startPrimaryTimer(){
    if (primaryTimerId || segmentRunning) return;
    primaryTimerId = setInterval(()=>{
      if (!paused) {
        primaryElapsed += 1;
        if (primaryElapsed >= intime && !segmentRunning) {
          runSegment();
        }
      }
    }, 1000);
  }
  function stopPrimaryTimer(){
    if (primaryTimerId) { clearInterval(primaryTimerId); primaryTimerId = null; }
  }

  const oldOnStateChange = window._origOnStateChange || null;
  function onStateChange(evt){
    if (evt.data === yt.PlayerState.PLAYING) {
      paused = false;
      startPrimaryTimer();
    } else if (evt.data === yt.PlayerState.PAUSED || evt.data === yt.PlayerState.BUFFERING) {
      paused = true;
    }
    if (typeof oldOnStateChange === 'function') try { oldOnStateChange(evt); } catch(e){}
  }
  try {
    if (player && player.addEventListener) {
      player.addEventListener('onStateChange', onStateChange);
    }
  } catch(e){}

  try {
    const st = player.getPlayerState && player.getPlayerState();
    if (st === yt.PlayerState.PLAYING) startPrimaryTimer();
  } catch(e){}

  function vidFromUrl(u){
    try {
      const url = new URL(u);
      if (url.hostname.includes('youtu.be')) return url.pathname.replace(/^\//, '');
      if (url.hostname.includes('youtube.com')) return url.searchParams.get('v');
    } catch(e){}
    return null;
  }
  const secondaryId = vidFromUrl(videoUrl);
  if (!secondaryId) {
    console.warn('Invalid video_url in relevant_video.json');
    return;
  }

  async function runSegment(){
    segmentRunning = true;
    stopPrimaryTimer();

    let resumeTime = 0;
    try { resumeTime = Math.floor(player.getCurrentTime() || 0); } catch(e){}

    try { player.pauseVideo(); } catch(e){}
    if (mainWrap) mainWrap.style.display = 'none';

    secondaryWrap.style.display = '';
    if (secondaryPlayer && secondaryPlayer.destroy) {
      try { secondaryPlayer.destroy(); } catch(e){}
      secondaryPlayer = null;
    }
    secondaryPlayer = new yt.Player('secondary-player', {
      videoId: secondaryId,
      playerVars: { start: Math.max(0, startTime), rel: 0, modestbranding: 1, controls: 1, iv_load_policy: 3 },
      events: {
        onReady: (e) => {
          try { e.target.seekTo(Math.max(0, startTime), true); } catch(e){}
          try { e.target.playVideo(); } catch(e){}
          startSecondaryTimer(resumeTime);
        }
      }
    });
  }

  let secondaryTimerId = null;
  function startSecondaryTimer(resumeTime){
    let elapsed = 0;
    if (secondaryTimerId) clearInterval(secondaryTimerId);
    const t0 = Date.now();
    secondaryTimerId = setInterval(()=>{
      elapsed = Math.floor((Date.now() - t0)/1000);
      if (elapsed >= segmentDuration) {
        clearInterval(secondaryTimerId);
        secondaryTimerId = null;
        try { secondaryPlayer && secondaryPlayer.pauseVideo && secondaryPlayer.pauseVideo(); } catch(e){}
        if (secondaryWrap) secondaryWrap.style.display = 'none';
        if (mainWrap) mainWrap.style.display = '';
        try { player.seekTo(resumeTime, true); player.playVideo(); } catch(e){}
        segmentRunning = false;
        startPrimaryTimer();
      }
    }, 1000);
  }
})();        
</script>
<script 
  type="module" src="./assets/relevant-swap.js">
</script>

<script type="module" src="./assets/relevant-swap.debug.js"></script>
</body>
</html>
