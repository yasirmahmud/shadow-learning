<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Course Video</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>
<body>
<header class="site-header">
  <div class="container">
    <div class="brand"><div class="uf-block">UF</div><h1>Course Video</h1></div>
    <nav class="site-nav"><a href="./index.html" class="nav-link">Home</a></nav>
  </div>
</header>
<main class="container">
  <div id="wrap" class="yt-wrap yt-16x9">
    <div id="player"></div>
  </div>
  <section id="chat" class="chat" hidden>
    <div class="chat-header">
      <strong>Discussion</strong>
      <button id="exit-chat" class="btn btn-ghost btn-sm" type="button">Exit Chat</button>
    </div>
    <div id="thread"></div>
    <form id="compose" class="compose">
      <input id="msg" class="input" type="text" placeholder="Type your question and press Enter" autocomplete="off"/>
      <button class="btn btn-orange" type="submit">Send</button>
    </form>
  </section>
</main>
<script type="module">
import { qs, el, saveViaVercel, askLaptop } from './assets/ui.js';

const params = new URLSearchParams(location.search);
const courseId = params.get('id');
let player, lastTime = 0;

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.innerHTML = `<div class="bubble">${text}</div>`;
  qs('#thread').append(div);
  qs('#thread').scrollTop = qs('#thread').scrollHeight;
}

function collectTranscript() {
  return [...document.querySelectorAll('.msg')].map(m => ({
    role: m.classList.contains('ai') ? 'assistant' : 'user',
    content: m.textContent.trim()
  }));
}

const compose = qs('#compose');
const msgInput = qs('#msg');

compose.addEventListener('submit', async ev => {
  ev.preventDefault();
  const text = msgInput.value.trim();
  if (!text) return;
  addMsg('user', text);
  msgInput.value = '';

  try {
    const response = await askLaptop({
      courseId,
      atSeconds: lastTime,
      messages: collectTranscript().map(m => ({
        role: m.role === 'assistant' ? 'assistant' : 'user',
        content: m.content
      }))
    });
    addMsg('ai', response.reply || 'No response.');
  } catch (err) {
    console.error(err);
    addMsg('ai', 'The assistant is unavailable right now. Please try again later.');
  }
});
</script>
</body>
</html>
