<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Course Video</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>
<body>
<header class="site-header">
  <div class="container">
    <div class="brand"><div class="uf-block">UF</div><h1>Course Video</h1></div>
    <nav class="site-nav"><a href="./index.html" class="nav-link">Home</a></nav>
  </div>
</header>
<main class="container">
  <div id="wrap" class="yt-wrap yt-16x9">
    <div id="player"></div>
    <div id="overlay" class="overlay" aria-hidden="true"></div>
  </div>
  <section id="chat" class="chat" hidden>
    <div class="chat-header">
      <strong>Discussion</strong>
      <button id="exit-chat" class="btn btn-ghost btn-sm" type="button">Exit Chat</button>
    </div>
    <div id="thread"></div>
    <form id="compose" class="compose">
      <input id="msg" class="input" type="text" placeholder="Type your question and press Enter" autocomplete="off"/>
      <button class="btn btn-orange" type="submit">Send</button>
    </form>
  </section>
</main>
<script type="module">
import { qs, el, saveViaVercel, askLaptop } from './assets/ui.js';

const params = new URLSearchParams(location.search);
const courseId = params.get('id');

function addMsg(role, text) {
  const row = document.createElement('div');
  row.className = 'msg ' + role;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  document.getElementById('thread').appendChild(row);
  document.getElementById('thread').scrollTop = document.getElementById('thread').scrollHeight;
}
function collectTranscript() {
  return [...document.querySelectorAll('.msg')].map(m => ({
    role: m.classList.contains('ai') ? 'assistant' : 'user',
    content: m.textContent.trim()
  }));
}

const compose = document.getElementById('compose');
const msgInput = document.getElementById('msg');
let lastTime = 0;

compose.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const text = msgInput.value.trim();
  if (!text) return;
  addMsg('user', text);
  msgInput.value = '';

  try {
    await saveViaVercel({
      course: courseId,
      savedAt: new Date().toISOString(),
      video_chat: { atSeconds: lastTime, videoId: 'youtube', messages: collectTranscript() }
    });
  } catch (e) { console.error(e); }

  try {
    const response = await askLaptop({
      courseId,
      atSeconds: lastTime,
      messages: collectTranscript().map(m => ({
        role: m.role === 'assistant' ? 'assistant' : 'user',
        content: m.content
      }))
    });
    addMsg('ai', response.reply || 'No response.');
  } catch (err) {
    console.error(err);
    addMsg('ai', 'The assistant is unavailable. Try again later.');
  }
});
</script>
</body>
</html>
