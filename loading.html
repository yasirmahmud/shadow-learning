<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Loading...</title>
  <link rel="stylesheet" href="./assets/style.css"/>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0021A5, #FA4616);
      color: white;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }
    .loader {
      text-align: center;
      animation: fadeIn 1s ease-in-out;
    }
    .spinner {
      width: 80px;
      height: 80px;
      border: 8px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="loader">
    <div class="spinner"></div>
    <h2>Processing your answers...</h2>
    <p>Please wait a moment</p>
  </div>
  <script>
  const params = new URLSearchParams(location.search);
  const courseId = params.get("id");

  const statusEl = document.querySelector(".loader p");
  const start = Date.now();

  if (!courseId) {
    statusEl.textContent = "Missing course ID in URL (?id=...).";
    throw new Error("No courseId");
  }

  async function fetchStatus(signal) {
    // Pass the courseId to the backend so it knows what to check
    const url = `https://saunciest-unethereal-clora.ngrok-free.dev/api/check-status?id=${encodeURIComponent(courseId)}&t=${Date.now()}`;
    const res = await fetch(url, { mode: "cors", signal });

    // Handle non-2xx early to avoid .json() throwing
    if (!res.ok) {
      throw new Error(`Status ${res.status}`);
    }
    const data = await res.json();

    // Normalize a few common shapes
    const ok = (
      data.ok === true ||
      data.status === "ok" ||
      data.success === true
    );

    const done = (
      data.done === true ||
      data.completed === true ||
      data.isDone === true ||
      data.status === "done" ||
      data.state === "completed"
    );

    return { ok, done, raw: data };
  }

  async function waitForBackend() {
    const maxMs = 120000; // stop after 2 minutes
    let delay = 1200;     // start interval ~1.2s

    while (true) {
      // Stop if we've waited too long
      const elapsed = Date.now() - start;
      if (elapsed > maxMs) {
        statusEl.textContent = "This is taking longer than expected. Please refresh or try again in a minute.";
        break;
      }

      // Use a per-request timeout so we don't hang on slow networks
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);

      try {
        const { ok, done } = await fetchStatus(controller.signal);

        if (ok && done) {
          statusEl.textContent = "Ready! Redirecting…";
          // Keep the id on redirect
          location.href = `./course-video.html?id=${encodeURIComponent(courseId)}`;
          return;
        } else {
          statusEl.textContent = "Still processing…";
        }
      } catch (err) {
        // Surface network/CORS/server issues for visibility
        statusEl.textContent = `Checking status… (retrying)`;
        // Optional: console for debugging
        console.warn("Status check failed:", err);
      } finally {
        clearTimeout(timeout);
      }

      // Simple backoff with a cap
      await new Promise(r => setTimeout(r, delay));
      delay = Math.min(delay + 300, 3000);
    }
  }

  waitForBackend();
</script>
</body>
</html>
